При обработке заказа используются разные подсистемы приложения: MES API, Message Queue, CRM API, S3 Storage и проблемы могут быть связаны с любой из них.

Примеры возможных причин: заказы зависают в определенном статусе из-за ошибки в логике приложения (MES API или CRM API), сообщения теряются на моменте отправки в брокер сообщений (перезапуск брокера сообщений, периодически заканчивается место на диске итд итп), а может вообще настроена политика очистки файлов в s3 хранилище, которая удаляет исходники моделей.

Трассировкой надо покрыть все соединения подсистем на пути обработки запросов.

В трейсинг должны попасть:

* trace_id
* span_id
* id ноды
* имя сервиса
* запрос (url + method)
* id заказа
* статус заказа + дата изменения

Нас интересует, в каком статусе зависают заказы и сколько требуется времени на их обработку. Всю остальную информацию предполагается брать из логов.

Мотивация

* Трейсинг упрощает поиск проблемных мест в системе, а также предоставляет контекст для анализа и дальнейшего устранения причин возникновения проблем. Это можно делать через упреждающий анализ (можно заметить, что заказ не доходит до конца пути) или по обращению пользователей, тем самым улучшая клиентский опыт (отзыв завис, но быстро нашли прчину и устранили)
* Появляется информация о том, какая подсистема дольше всего выполняет запрос и требует повышенного внимания.
* Дешевле, чем внедрение детального логирования и дальнейший анализ и визуализация этих логов.


Предлагаемое решение

Внедряем стандартизированное и проверенное решение OpenTelemetry в подсистемы:

* Shop API
* CRM API
* MES API

Храним и визуализируем трейсы с помощью Jaeger.

Компромиссы

* Внедрить телеметрию в s3, БД и брокер сообщений, которые используют свои протоколы, не получится.
* Большое кол-во трейсов может давать оверхед на производительность системы, плюс ко всему стремительно будут выедать место на диске, этот процесс нужно контролировать.
* Если используется проприетарное ПО для интернет-магазина или CRM, то может быть проблема с внедрением трейсинга, если его нет из коробки.
* Система MES написана сторонними разработчиками и стоимость внедрения OT может быть высокой.

Безопасность

* Сетевой доступ к Jaeger UI будет только из внутренней сети или VPN
* Доступ к Jaeger UI будут иметь только разработчики (с ролью Техподдержка), неподготовленные специалисты вряд ли смогут проанализировать и понять трейсы
* Контекст трейсов не должен содержать персональных или чувствительных данных